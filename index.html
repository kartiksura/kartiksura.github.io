<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Find popular places around you</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9H97RK50TD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9H97RK50TD');
  </script>

  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.2/css/bootstrap.min.css'>
  <link rel='stylesheet' href='https://use.fontawesome.com/releases/v5.3.1/css/all.css'>
  <style>
    :root {
      --map-height-mobile: 240px;
      --map-height-desktop: 360px;
    }
    body { background: #000; font-family: "Open Sans", sans-serif; }

    #header { width: 100%; height: 220px; background: #000; }

    /* FIX 1: give the map an explicit pixel height so it renders and doesn't overlap content */
    #map { height: var(--map-height-mobile); border-radius: .5rem; }
    @media (min-width: 768px) { #map { height: var(--map-height-desktop); } }

    .wrap { width: 80%; max-width: 900px; margin: 0 auto; }

    .searchTerm { width: 100%; border: 3px solid #00b4cc; padding: 5px 12px; height: 56px; border-radius: 6px; outline: none; font-size: 18px; }

    .list-group { width: 100%; font-size: 18px; color: #000; }

    /* Ensure list items stack and are visible */
    .list-group-item { display: block; }

    /* Avoid any accidental overlap from positioned children inside Google Maps */
    #results { position: relative; z-index: 1; }

    .image-parent { max-width: 190px; }

    .place-thumb { width: 100%; height: 120px; object-fit: cover; border-radius: .5rem; }
  </style>
</head>
<body>
  <header id="header" class="d-flex flex-column justify-content-center align-items-center text-center">
    <h1 class="text-warning mb-2">Find popular places</h1>
    <h4 class="text-secondary mb-1">Powered by Google Maps, sorted by number of reviews</h4>
    <h6 class="text-secondary">Great for touristy areas where popularity matters</h6>
  </header>

  <main class="container pb-4">
    <div class="wrap">
      $1<div class="d-flex align-items-center mb-2">
        <label for="distance-filter" class="text-light mr-2 mb-0">Max distance:</label>
        <select id="distance-filter" class="custom-select w-au

      <div id="results" class="list-group"></div>
    </div>

    <div class="footer text-center mt-4">
      <p class="text-secondary mb-1">There are alternative algorithms (e.g., weight 5★ more, etc.).</p>
      <p class="mb-0"><a href="https://forms.gle/HCXEhe5EnspUp5778">Send feedback or feature requests</a></p>
    </div>
  </main>

  <script>
    // Utility to safely read nested fields
    function getValue(data, path) {
      for (let i = 0; typeof data === "object" && i < path.length; ++i) data = data[path[i]];
      return data;
    }

    function initAutocomplete() {
      const results = document.getElementById("results");

      const map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -33.8688, lng: 151.2195 },
        zoom: 15,
        mapTypeId: "roadmap",
      });

      if (navigator.geolocation) {
        const location_timeout = setTimeout(() => {/* noop fallback */}, 8000);
        navigator.geolocation.getCurrentPosition((position) => {
          clearTimeout(location_timeout);
          map.setCenter({ lat: position.coords.latitude, lng: position.coords.longitude });
        });
      }

      // Keep the input where it is in the layout (NOT inside map controls) for predictable desktop layout
      const input = document.getElementById("pac-input");
      const searchBox = new google.maps.places.SearchBox(input);

      map.addListener("bounds_changed", () => searchBox.setBounds(map.getBounds()));

      let markers = [];

      searchBox.addListener("places_changed", () => {
        const places = searchBox.getPlaces() || [];
        results.innerHTML = "";
        if (!places.length) return;

        // Clear markers
        markers.forEach((m) => m.setMap(null));
        markers = [];

        const bounds = new google.maps.LatLngBounds();

        // Sort primarily by number of reviews (popularity)
        places.sort((a, b) => (b.user_ratings_total || 0) - (a.user_ratings_total || 0));

        places.forEach((place) => {
          if (!place.geometry || !place.geometry.location) return;

          const info = {
            name: place.name,
            rating: place.rating ?? "N/A",
            user_ratings_total: place.user_ratings_total ?? 0,
            isOpen: getValue(place, ["opening_hours", "open_now"]) ?? null,
            photo: null,
            address: place.formatted_address || "",
            maps_link: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.formatted_address || place.name)}&query_place_id=${place.place_id}`,
          };

          if (Array.isArray(place.photos) && place.photos.length) {
            try { info.photo = place.photos[0].getUrl({ maxWidth: 600, maxHeight: 400 }); } catch (_) {}
          }

          const thumb = info.photo ||
            "https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg";

          // Render list item
          const html = `
            <a href="${info.maps_link}" target="_blank" rel="noopener" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2">
              <div class="flex-grow-1 pr-3">
                <strong class="text-dark d-block">${info.name}</strong>
                <small class="text-muted d-block">${info.address}</small>
                ${info.isOpen === true ? `<span class="badge badge-success mr-2">Open now</span>` : info.isOpen === false ? `<span class="badge badge-danger mr-2">Closed</span>` : ""}
                <span class="badge badge-info">${info.user_ratings_total} ratings</span>
                ${info.rating !== "N/A" ? `<span class="ml-2">⭐ ${info.rating}</span>` : ""}
              </div>
              <div class="image-parent">
                <img src="${thumb}" alt="${info.name}" class="place-thumb" />
              </div>
            </a>`;

          results.insertAdjacentHTML('beforeend', html);

          // Marker
          markers.push(new google.maps.Marker({ map, title: place.name, position: place.geometry.location }));

          if (place.geometry.viewport) bounds.union(place.geometry.viewport); else bounds.extend(place.geometry.location);
        });

        map.fitBounds(bounds);
      });
    }

    window.initAutocomplete = initAutocomplete;
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBCDJZDoS6NBc0JYuk11tx7v2kmIKR5I1I&callback=initAutocomplete&libraries=places&v=weekly" defer></script>

  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/popper.min.js'></script>
  <script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js'></script>
</body>
</html>
