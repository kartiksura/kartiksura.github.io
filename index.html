<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9H97RK50TD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-9H97RK50TD');
  </script>

  <meta charset="UTF-8" />
  <title>Find popular places around you</title>

  <!-- Only CSS (no external JS to avoid 'export' errors) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.2/css/bootstrap.min.css" />

  <style>
    body { background: #000; font-family: "Open Sans", sans-serif; }
    .searchTerm {
      width: 100%; border: 3px solid #00b4cc; padding: 5px; height: 60px;
      border-radius: 5px; outline: none; font-size: 20px;
    }
    #map { height: 260px; border-radius: 6px; }
    .image-parent { max-width: 190px; }
    .list-group { font-size: 18px; color: #000; }
    .hint { font-size: 12px; opacity: 0.75; }
    .btn-toggle .btn { cursor: pointer; }

    /* Thicker, easier-to-grab slider */
    #distance-slider {
      -webkit-appearance: none; width: 100%; height: 16px; background: transparent; margin: 6px 0;
      cursor: pointer; touch-action: pan-y;
    }
    #distance-slider:focus { outline: none; }
    #distance-slider::-webkit-slider-runnable-track {
      height: 16px; background: #1b1b1b; border-radius: 10px; border: 1px solid #00b4cc;
    }
    #distance-slider::-webkit-slider-thumb {
      -webkit-appearance: none; margin-top: -6px; width: 28px; height: 28px; border-radius: 50%;
      background: #00b4cc; border: 2px solid #66e0ef; box-shadow: 0 0 0 3px rgba(0,180,204,0.15);
    }
    #distance-slider:active::-webkit-slider-thumb { transform: scale(1.05); }
    #distance-slider::-moz-range-track {
      height: 16px; background: #1b1b1b; border-radius: 10px; border: 1px solid #00b4cc;
    }
    #distance-slider::-moz-range-thumb {
      width: 28px; height: 28px; border-radius: 50%;
      background: #00b4cc; border: 2px solid #66e0ef; box-shadow: 0 0 0 3px rgba(0,180,204,0.15);
    }
    #distance-slider::-ms-track { height: 16px; background: transparent; border-color: transparent; color: transparent; }
    #distance-slider::-ms-fill-lower, #distance-slider::-ms-fill-upper {
      height: 16px; background: #1b1b1b; border: 1px solid #00b4cc; border-radius: 10px;
    }
    #distance-slider::-ms-thumb {
      width: 28px; height: 28px; border-radius: 50%; background: #00b4cc; border: 2px solid #66e0ef;
    }
  </style>
</head>

<body translate="no">
  <div class="container pt-3">
    <h1 class="text-warning text-center">Find popular places</h1>
    <h4 class="text-secondary text-center">Filter by distance and choose Top or New places.</h4>

    <!-- Search box stays in page flow (not moved into map controls) -->
    <input id="pac-input" class="searchTerm" placeholder="E.g. Cafes near Whitefield" autofocus />

    <!-- Sorting mode toggle (vanilla JS manages .active) -->
    <div class="mt-2 text-light btn-toggle" id="mode-container" role="group" aria-label="Sort mode">
      <button class="btn btn-sm btn-outline-info active" data-mode="top" title="Sort by number of ratings">Top places</button>
      <button class="btn btn-sm btn-outline-info" data-mode="new" title="Newest places first">New places</button>
      <div class="hint mt-1">Top = by number of ratings. New = earliest review date (fallback shown as “unknown”).</div>
    </div>

    <!-- Distance slider UI -->
    <div class="mt-2 text-light">
      <label for="distance-slider">Max distance: <span id="distance-value">5</span> km</label>
      <input type="range" id="distance-slider" min="1" max="50" value="5" step="1" />
      <div class="hint mt-1">Measured from your location (if allowed) or the current map center.</div>
    </div>

    <!-- Map + Results -->
    <div class="mt-3">
      <div id="map" class="mb-3"></div>
      <div id="results" class="list-group"></div>
    </div>
  </div>

  <script>
    // Swallow noisy extension promise errors (unrelated to our code)
    window.addEventListener('unhandledrejection', (e) => {
      const msg = String((e && e.reason && e.reason.message) || e.reason || '');
      if (msg.includes('A listener indicated an asynchronous response')) e.preventDefault();
    });

    function geolocFail(){/* no-op */}
    function getValue(data, path){ for(let i=0;i<path.length && typeof data==="object";i++) data=data[path[i]]; return data; }

    // Distance helpers
    function haversineKm(a,b){ const toRad=d=>d*Math.PI/180;
      const lat1=a.lat(),lon1=a.lng(),lat2=b.lat(),lon2=b.lng(),R=6371;
      const dLat=toRad(lat2-lat1), dLon=toRad(lon2-lon1);
      const s1=Math.sin(dLat/2)**2, s2=Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(s1+s2)); }
    function distanceMeters(origin, loc){
      if (window.google?.maps?.geometry?.spherical) return google.maps.geometry.spherical.computeDistanceBetween(origin, loc);
      return haversineKm(origin, loc)*1000;
    }

    // Age formatting
    function formatAge(tsMs){
      if (!tsMs || isNaN(tsMs)) return "unknown";
      const now=Date.now(); let diff=Math.max(0, now-tsMs);
      const day=86400000, year=365.25*day, month=30.44*day;
      const y=Math.floor(diff/year); diff-=y*year;
      const m=Math.floor(diff/month); diff-=m*month;
      const d=Math.floor(diff/day);
      if (y>=1) return `${y} yr${y>1?'s':''}${m?` ${m} mo`:''}`;
      if (m>=1) return `${m} mo${d?` ${d} d`:''}`;
      if (d>=1) return `${d} d`;
      const h=Math.floor(diff/3600000); if (h>=1) return `${h} hr${h>1?'s':''}`;
      const min=Math.floor(diff/60000); if (min>=1) return `${min} min`;
      return "today";
    }

    let map, placesService, searchBox;
    let markers = [];
    let lastPlaces = [];
    let origin;
    const ageCache = new Map();   // place_id -> { score, tsMs, source }
    const agePending = new Map(); // place_id -> Promise<meta>
    let renderSeq = 0;            // avoid stale re-renders

    function currentMode(){
      const active = document.querySelector('#mode-container .btn.active');
      return active?.dataset.mode || 'top';
    }
    function setModeButtons(mode){
      document.querySelectorAll('#mode-container .btn').forEach(btn=>{
        btn.classList.toggle('active', btn.dataset.mode===mode);
      });
    }

    function initAutocomplete(){
      const resultsEl = document.getElementById("results");
      const input = document.getElementById("pac-input");
      const slider = document.getElementById("distance-slider");
      const distanceValue = document.getElementById("distance-value");
      const modeContainer = document.getElement
