<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Find popular places around you</title>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9H97RK50TD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-9H97RK50TD');
  </script>

  <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.2/css/bootstrap.min.css'>
  <style>
    body { background: #000; font-family: "Open Sans", sans-serif; }
    #header { width: 100%; height: 220px; background: #000; }
    #map { height: 360px; border-radius: .5rem; }
    .wrap { width: 80%; max-width: 900px; margin: 0 auto; }
    .searchTerm { width: 100%; border: 3px solid #00b4cc; padding: 5px 12px; height: 56px; border-radius: 6px; outline: none; font-size: 18px; }
    .list-group { width: 100%; font-size: 18px; color: #000; }
    .list-group-item { display: block; }
    #results { position: relative; z-index: 1; }
    .image-parent { max-width: 190px; }
    .place-thumb { width: 100%; height: 120px; object-fit: cover; border-radius: .5rem; }
  .pac-container { z-index: 10000 !important; }
  </style>
</head>
<body>
  <header id="header" class="d-flex flex-column justify-content-center align-items-center text-center">
    <h1 class="text-warning mb-2">Find popular places</h1>
    <h4 class="text-secondary mb-1">Powered by Google Maps, sorted by reviews with optional distance filter</h4>
  </header>

  <main class="container pb-4">
    <div class="wrap">
      <input id="pac-input" class="searchTerm mb-3" placeholder="E.g. Cafes near Whitefield" />
      <div class="mb-3 d-flex align-items-center">
        <label class="text-light mr-2 mb-0">Max distance:</label>
        <select id="distance-filter" class="custom-select w-auto">
          <option value="any">Any</option>
          <option value="500">500 m</option>
          <option value="1000">1 km</option>
          <option value="2000">2 km</option>
          <option value="5000">5 km</option>
          <option value="10000">10 km</option>
        </select>
      </div>
      <div id="map" class="mb-3"></div>
      <div id="results" class="list-group"></div>
    </div>
  </main>

  <script>
    let userPos = null;
    function getValue(data, path) {
      for (let i = 0; typeof data === "object" && i < path.length; ++i) data = data[path[i]];
      return data;
    }

    function initAutocomplete() {
      const results = document.getElementById("results");
      const distanceSelect = document.getElementById("distance-filter");
      const map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -33.8688, lng: 151.2195 },
        zoom: 15,
        mapTypeId: "roadmap",
      });

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
          userPos = { lat: position.coords.latitude, lng: position.coords.longitude };
          map.setCenter(userPos);
        });
      }

      const input = document.getElementById("pac-input");
      const searchBox = new google.maps.places.SearchBox(input);
      map.addListener("bounds_changed", () => searchBox.setBounds(map.getBounds()));

      let markers = [];
      let lastPlaces = [];
      const infowindow = new google.maps.InfoWindow();

      function clearMarkers() { markers.forEach((m) => m.setMap(null)); markers = []; }
      function fmtDistance(m) { return m < 1000 ? `${Math.round(m)} m` : `${(m/1000).toFixed(1)} km`; }

      function renderPlaces() {
        results.innerHTML = "";
        clearMarkers();
        if (!lastPlaces.length) return;

        const allBounds = new google.maps.LatLngBounds();
        lastPlaces.forEach(p => {
          if (p.geometry && p.geometry.location) {
            if (p.geometry.viewport) allBounds.union(p.geometry.viewport);
            else allBounds.extend(p.geometry.location);
          }
        });
        const origin = allBounds.isEmpty() ? map.getCenter() : allBounds.getCenter();
        const maxMeters = distanceSelect.value === 'any' ? Infinity : parseInt(distanceSelect.value, 10);
        const bounds = new google.maps.LatLngBounds();

        const sorted = [...lastPlaces].sort((a, b) => (b.user_ratings_total || 0) - (a.user_ratings_total || 0));

        sorted.forEach((place) => {
          if (!place.geometry || !place.geometry.location) return;

          const distance = google.maps.geometry.spherical.computeDistanceBetween(origin, place.geometry.location);
          if (distance > maxMeters) return;

          const info = {
            name: place.name,
            rating: place.rating ?? "N/A",
            user_ratings_total: place.user_ratings_total ?? 0,
            isOpen: getValue(place, ["opening_hours", "open_now"]) ?? null,
            photo: null,
            address: place.formatted_address || "",
            maps_link: `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(place.formatted_address || place.name)}&query_place_id=${place.place_id}`,
            distance: fmtDistance(distance),
          };

          if (Array.isArray(place.photos) && place.photos.length) {
            try { info.photo = place.photos[0].getUrl({ maxWidth: 600, maxHeight: 400 }); } catch (_) {}
          }

          const thumb = info.photo || "https://upload.wikimedia.org/wikipedia/commons/6/65/No-Image-Placeholder.svg";

          const html = `
            <a href="${info.maps_link}" target="_blank" rel="noopener" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center mb-2">
              <div class="flex-grow-1 pr-3">
                <strong class="text-dark d-block">${info.name}</strong>
                <small class="text-muted d-block">${info.address}</small>
                ${info.isOpen === true ? `<span class="badge badge-success mr-2">Open now</span>` : info.isOpen === false ? `<span class="badge badge-danger mr-2">Closed</span>` : ""}
                <span class="badge badge-info">${info.user_ratings_total} ratings</span>
                ${info.rating !== "N/A" ? `<span class="ml-2">‚≠ê ${info.rating}</span>` : ""}
                <span class="badge badge-secondary ml-2">üìç ${info.distance}</span>
              </div>
              <div class="image-parent">
                <img src="${thumb}" alt="${info.name}" class="place-thumb" />
              </div>
            </a>`;

          results.insertAdjacentHTML('beforeend', html);

          const marker = new google.maps.Marker({ map, title: place.name, position: place.geometry.location });
          marker.addListener("click", () => {
            infowindow.setContent(`
              <div style="font-size:14px">
                <strong>${info.name}</strong><br/>
                ${info.address}<br/>
                ‚≠ê ${info.rating} (${info.user_ratings_total} reviews)<br/>
                ${info.distance}
              </div>
            `);
            infowindow.open(map, marker);
          });

          markers.push(marker);
          if (place.geometry.viewport) bounds.union(place.geometry.viewport); else bounds.extend(place.geometry.location);
        });

        if (!bounds.isEmpty()) map.fitBounds(bounds);
      }

      searchBox.addListener("places_changed", () => {
        lastPlaces = searchBox.getPlaces() || [];
        renderPlaces();
      });

      distanceSelect.addEventListener('change', renderPlaces);
    }
    window.initAutocomplete = initAutocomplete;
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBCDJZDoS6NBc0JYuk11tx7v2kmIKR5I1I&callback=initAutocomplete&libraries=places,geometry&v=weekly" defer></script>
</body>
</html>
