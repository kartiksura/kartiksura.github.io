<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Find popular places around you</title>

  <!-- Google Analytics (optional, keep/remove as you prefer) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9H97RK50TD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} gtag('js', new Date());
    gtag('config', 'G-9H97RK50TD');
  </script>

  <!-- Bootstrap & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css">

  <style>
    :root {
      --bg: #000;
      --card-bg: #fff;
      --accent: #00b4cc;
      --muted: #6c757d;
    }

    body { background: var(--bg); font-family: "Open Sans", sans-serif; }

    #header { width: 100%; height: 220px; background: #000; position: relative; }

    h1, h4 { text-align: center; }

    #map { height: 260px; border-radius: 10px; }

    .searchTerm {
      width: 100%; border: 3px solid var(--accent); padding: 10px; height: 60px;
      border-radius: 8px; outline: none; font-size: 18px;
    }

    .controls { gap: 14px; }

    .distance-control { background: #0e0e0e; border: 1px solid #1f1f1f; border-radius: 12px; padding: 12px; color: #e9ecef; }
    .distance-control label { margin-bottom: 6px; display: block; font-weight: 600; }
    .distance-control .value { font-weight: 700; }
    .distance-range { width: 100%; }

    .list-group { width: 100%; font-size: 16px; color: #000; }
    .place-card { border: 0; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); margin-bottom: 10px; }
    .place-card .badge { font-size: 12px; }
    .image-parent { max-width: 160px; }

    .open-now { color: #0d6efd; }
    .closed { color: #dc3545; }
    .no-hours { color: var(--muted); }
  </style>
</head>
<body>
  <div id="header" class="d-flex flex-column justify-content-center">
    <h1 class="text-warning">Find popular places</h1>
    <h4 class="text-secondary">Powered by Google Maps. Sorted by number of reviews (popularity).</h4>
    <h4 class="text-secondary">Add a distance filter to focus results nearby.</h4>
  </div>

  <div class="container pb-5">
    <div class="row controls align-items-stretch">
      <div class="col-lg-8 mb-3">
        <div class="input-group input-group-lg">
          <input id="pac-input" class="form-control searchTerm" placeholder="E.g. Cafes near Whitefield" />
          <div class="input-group-append">
            <button id="go-btn" class="btn
      <div class="col-lg-4 mb-3">
        <div class="distance-control h-100">
          <label for="distance-km">Distance filter</label>
          <div class="d-flex align-items-center justify-content-between">
            <small class="text-light">Within <span id="distance-km-label" class="value">5</span> km</small>
            <small class="text-muted">(from your location or map center)</small>
          </div>
          <input id="distance-km" class="distance-range mt-2" type="range" min="1" max="20" step="1" value="5" list="tickmarks" />
          <datalist id="tickmarks">
            <option value="1"></option>
            <option value="2"></option>
            <option value="5"></option>
            <option value="10"></option>
            <option value="15"></option>
            <option value="20"></option>
          </datalist>
        </div>
      </div>
    </div>

    <div class="mb-3">
      <div id="map"></div>
    </div>

    <div class="list-group" id="results"></div>

    <div class="footer text-center mt-4">
      <p class="text-secondary">There are many alternative ranking formulas (e.g., weight by 5★ count). Currently sorting by total number of ratings.</p>
      <p><a class="text-info" href="https://forms.gle/HCXEhe5EnspUp5778">Share feedback & feature requests</a></p>
    </div>
  </div>

  <!-- Load Google Maps JS API: add your key and ensure libraries include places & geometry -->
  <!-- Replace YOUR_API_KEY below with your actual key -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&callback=initAutocomplete&libraries=places,geometry&v=weekly" defer></script>

  <script>
    // Globals
    let map;
    let markers = [];
    let lastPlaces = [];
    let userPos = null; // google.maps.LatLng | null
    let distanceLimitKm = 5;

    // Added: shared InfoWindow and PlacesService for marker clicks/details
    let infoWindow;
    let placesService;

    // Utility: compute distance in KM using Google geometry lib
    function distanceKm(originLatLng, destLatLng) {
      if (!originLatLng || !destLatLng) return Infinity;
      const meters = google.maps.geometry.spherical.computeDistanceBetween(originLatLng, destLatLng);
      return meters / 1000.0;
    }

    function clearMarkers() {
      markers.forEach(m => m.setMap(null));
      markers = [];
    }

    function placeLink(place) {
      // More robust maps link via place_id
      return `https://www.google.com/maps/place/?q=place_id:${place.place_id}`;
    }

    function ratingStars(rating) {
      const r = Math.round(rating || 0);
      return '★'.repeat(r) + '☆'.repeat(5 - r);
    }

    $1
    // Compute the geographic center of a set of places
    function centerOfPlaces(places) {
      const b = new google.maps.LatLngBounds();
      (places || []).forEach(p => {
        if (p && p.geometry && p.geometry.location) b.extend(p.geometry.location);
      });
      return b.isEmpty() ? null : b.getCenter();
    }

    // Build HTML for the marker info window (avoids template literals for easy injection)
    function buildInfoHtml(info) {
      var addr = info.formatted_address || info.vicinity || '';
      var rating = info.rating;
      var total = info.user_ratings_total || 0;
      var distanceText = (info._distanceKm != null && isFinite(info._distanceKm)) ? (info._distanceKm.toFixed(1) + ' km') : '';
      var website = info.website;
      var phone = info.international_phone_number;
      var link = info.link || info.url || (info.place_id ? ('https://www.google.com/maps/place/?q=place_id:' + info.place_id) : '#');
      var stars = rating ? ('★'.repeat(Math.round(rating)) + '☆'.repeat(5 - Math.round(rating))) : '';
      return [
        '<div style="max-width:260px">',
          '<div style="font-weight:700; margin-bottom:4px;">', (info.name || 'Place'), '</div>',
          rating ? ('<div><span class="text-warning">' + stars + '</span> <span>(' + total + ')</span></div>') : '',
          addr ? ('<div style="color:#6c757d; font-size:12px;">' + addr + '</div>') : '',
          distanceText ? ('<div style="color:#6c757d; font-size:12px; margin-top:4px;">' + distanceText + ' away</div>') : '',
          '<div style="margin-top:6px;">',
            '<a href="', link, '" target="_blank" rel="noopener noreferrer">Open in Google Maps</a>',
          '</div>',
          website ? ('<div style="font-size:12px; margin-top:4px;"><a href="' + website + '" target="_blank" rel="noopener noreferrer">Website</a></div>') : '',
          phone ? ('<div style="font-size:12px; color:#6c757d;">' + phone + '</div>') : '',
        '</div>'
      ].join('');
    }

    function renderListAndMarkers(places) {
      const list = document.getElementById('results');
      list.innerHTML = '';
      clearMarkers();

      if (!places.length) {
        list.innerHTML = `<div class="list-group-item place-card">
          <div class="d-flex justify-content-between align-items-center">
            <div><strong>No places within ${distanceLimitKm} km</strong><p class="mb-0 text-muted">Try increasing the distance or adjusting your query.</p></div>
          </div>
        </div>`;
        return;
      }

      const bounds = new google.maps.LatLngBounds();

      places.forEach(place => {
        const info = {
          name: place.name,
          rating: place.rating,
          user_ratings_total: place.user_ratings_total || 0,
          isOpen: place.opening_hours && typeof place.opening_hours.open_now === 'boolean' ? place.opening_hours.open_now : null,
          photo: Array.isArray(place.photos) && place.photos.length ? place.photos[0].getUrl() : null,
          link: placeLink(place),
          distanceKm: place._distanceKm,
        };

        // Card UI
        const openHtml = (info.isOpen === true)
          ? '<p class="open-now mb-1"><small>Open now</small></p>'
          : (info.isOpen === false)
            ? '<p class="closed mb-1"><small>Closed</small></p>'
            : '<p class="no-hours mb-1"><small>No hours info</small></p>';

        const photoHtml = info.photo
          ? `<div class="image-parent ml-3"><img src="${info.photo}" class="img-fluid rounded" alt="${info.name}" loading="lazy"></div>`
          : '';

        const card = document.createElement('a');
        card.href = info.link;
        card.target = '_blank';
        card.rel = 'noopener noreferrer';
        card.className = 'list-group-item list-group-item-action place-card d-flex justify-content-between align-items-center';
        card.innerHTML = `
          <div class="flex-column">
            <strong class="text-dark d-block">${info.name}</strong>
            <div class="d-flex align-items-center mb-1">
              <span class="text-warning mr-2">${ratingStars(info.rating)}</span>
              <span class="badge badge-info badge-pill">${info.user_ratings_total} ratings</span>
            </div>
            ${openHtml}
            <small class="text-muted">${formatDistance(info.distanceKm)}</small>
          </div>
          ${photoHtml}
        `;
        list.appendChild(card);

        // Marker
        if (place.geometry && place.geometry.location) {
          const marker = new google.maps.Marker({
            map,
            title: place.name,
            position: place.geometry.location,
          });
          markers.push(marker);
          // Show details when a marker is clicked
          marker.addListener('click', function() {
            var base = {
              name: info.name,
              rating: info.rating,
              user_ratings_total: info.user_ratings_total,
              formatted_address: place.formatted_address || place.vicinity,
              place_id: place.place_id,
              link: info.link,
              _distanceKm: info.distanceKm
            };
            if (infoWindow) {
              infoWindow.close();
              infoWindow.setContent(buildInfoHtml(base));
              infoWindow.open(map, marker);
            }
            if (placesService && place.place_id) {
              placesService.getDetails({
                placeId: place.place_id,
                fields: ['name','formatted_address','rating','user_ratings_total','opening_hours','website','international_phone_number','url','photos']
              }, function(details, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK && details) {
                  details._distanceKm = base._distanceKm;
                  details.link = base.link;
                  infoWindow.setContent(buildInfoHtml(details));
                  infoWindow.open(map, marker);
                }
              });
            }
          });
          if (place.geometry.viewport) bounds.union(place.geometry.viewport); else bounds.extend(place.geometry.location);
        }
      });

      // Fit bounds to filtered places
      if (!bounds.isEmpty()) {
        map.fitBounds(bounds);
      }
    }

    function filterAndRender() {
      if (!lastPlaces.length || !map) return;

      // Prefer user's geolocation; otherwise infer center from the returned places; fallback to map center
      const inferred = centerOfPlaces(lastPlaces);
      const origin = userPos || inferred || map.getCenter();

      // Annotate with distance and filter by selected limit
      const annotated = lastPlaces.map(p => {
        try {
          p._distanceKm = distanceKm(origin, p.geometry && p.geometry.location);
        } catch { p._distanceKm = Infinity; }
        return p;
      });

      let filtered = annotated
        .filter(p => p._distanceKm <= distanceLimitKm)
        .sort((a, b) => (b.user_ratings_total || 0) - (a.user_ratings_total || 0));

      // If nothing within the distance and we don't have user geolocation yet, relax to show all (so users see *something*)
      if (!filtered.length && !userPos) {
        filtered = annotated.sort((a, b) => (b.user_ratings_total || 0) - (a.user_ratings_total || 0));
      }

      renderListAndMarkers(filtered);
    } catch { p._distanceKm = Infinity; }
        return p;
      });

      const filtered = annotated
        .filter(p => p._distanceKm <= distanceLimitKm)
        .sort((a, b) => (b.user_ratings_total || 0) - (a.user_ratings_total || 0));

      renderListAndMarkers(filtered);
    }

    function initAutocomplete() {
      const resultsDiv = document.getElementById('results');
      const distanceSlider = document.getElementById('distance-km');
      const distanceLabel = document.getElementById('distance-km-label');

      // Init map with a neutral default; will recenter to geolocation if allowed
      map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: 12.9716, lng: 77.5946 }, // Bengaluru as a sensible default
        zoom: 14,
        mapTypeId: 'roadmap',
      });
      // Initialize shared InfoWindow and PlacesService for marker clicks/details
      infoWindow = new google.maps.InfoWindow();
      placesService = new google.maps.places.PlacesService(map);

      // Try to use geolocation for origin
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userPos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
            map.setCenter(userPos);
            filterAndRender(); // re-evaluate distances if we already have places
          },
          () => { /* ignore errors; fallback to map center */ }
        );
      }

      // SearchBox
      const input = document.getElementById('pac-input');
      const searchBox = new google.maps.places.SearchBox(input);      // Keep the search box in the page layout (outside the map).
      // If you want it inside the map UI, re-enable the next line.
      // map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

      // Bias results to current viewport
      map.addListener('bounds_changed', () => {
        const bounds = map.getBounds();
        if (bounds) searchBox.setBounds(bounds);
      });

      // Distance slider interactions
      distanceSlider.addEventListener('input', () => {
        distanceLimitKm = parseFloat(distanceSlider.value);
        distanceLabel.textContent = distanceLimitKm;
        filterAndRender();
      });

      // When user selects a prediction
      searchBox.addListener('places_changed', () => {
        const places = searchBox.getPlaces() || [];
        resultsDiv.innerHTML = '';
        clearMarkers();
        lastPlaces = [];

        if (!places.length) return;

        // Only keep places with geometry
        lastPlaces = places.filter(p => p && p.geometry && p.geometry.location);

        // Fit map to all returned places immediately so the user sees the area of interest
        const b = new google.maps.LatLngBounds();
        lastPlaces.forEach(p => b.extend(p.geometry.location));
        if (!b.isEmpty()) map.fitBounds(b);

        filterAndRender();
      });
    }

    window.initAutocomplete = initAutocomplete;
  </script>

  <!-- Optional: Bootstrap JS (not required for core functionality) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</body>
</html>
